                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        % Input:
% Different inputs are needed depending on the model. The relevant ones for
% now on are:
% - maxFix: Deprecated. The fixation is selected through the fixatedArea
%                                                               variable. 
% - images:
% - salientPercentThr:
% - fixatedArea:
% - mode: Model.
%
% Output:
% - meanSalientPercent
% - meanTPR: Mean (accross images) True Positive Rate: 
%                           TP_{perc,im} ./ (TP_{perc,im} + FN_{perc,im})
% - errTPR: Standard Error of the Mean (accross images) of the TPR:
%                           std(TP_{perc,im}) ./ sqrt(length(TP_{perc,im})))
%                           for the images with enough responses.
% - meanFPR: Mean (accross images) False Positive Rate:
%                           FP_{perc,im} ./ (FP_{perc,im} + TN_{perc,im})
% - errFPR: idem errTPR.


% History.
% (08/2019, JK) ToDo
%   * Que hace maxFix aca? Parece estar completamente de mas. Igual lo dejo
%           por herencia
%   * Incluir mas modelos.
%   * Incluir calculo de AUC con error.
%
% (02/09/2019, JK)
%   * Separe la seleccion de modelos que estaba muy larga. 
%           fun_select_model()
%           Si en algun momento no anda con algun modelo nuevo hay que
%           revisar que estemos pasando todos los parametros.

function [meanSalientPercent, meanTPR, errTPR, meanFPR, errFPR, true_positives, true_negatives, false_positives, false_negatives] = tpr_vs_area(maxFix, images, ...
                templates, salientPercentThr, fixatedArea, mode, horizonMode, modelIdx, ...
                ModelsJudd, ROCPerformancesJudd, dimsJudd)
    if nargin < 7
        horizonMode = 'constant';
    end
    
    fprintf(['Finding ' mode ' features...\n']); tic;

%     true_positives  = zeros(16, 256, length(images));
%     true_negatives  = zeros(16, 256, length(images));
%     false_positives = zeros(16, 256, length(images));
%     false_negatives = zeros(16, 256, length(images));
    true_positives  = zeros(length(salientPercentThr), length(images));
    true_negatives  = zeros(length(salientPercentThr), length(images));
    false_positives = zeros(length(salientPercentThr), length(images));
    false_negatives = zeros(length(salientPercentThr), length(images));

    salientPercent = nan(length(salientPercentThr), length(images));
    location_words = {};
    for im = 1:length(images)
%        if isempty(find([1 8 11 23 26 28] == im, 1))
%            continue;
%        end
%         keyboard
        [features, tRange] = fun_select_model(mode, images, im);
        
        salientPercentAux = [];        
        for t = tRange
%             salientPercentAux(end+1) = sum(sum(features >= t)) * 100 ./ (768*1024);
            salientPercentAux(end+1) = 100 * sum(sum(features >= t)) ./ (size(features,1)*size(features,2));
        end
        
        for p = 1:length(salientPercentThr)
            [~, t] = min(abs(salientPercentThr(p)-(salientPercentAux)));
            thr = features >= tRange(t);
            true_positives(p, im)  = sum(sum(fixatedArea(:,:,im) == 1 & thr == 1));
            false_negatives(p, im) = sum(sum(fixatedArea(:,:,im) == 1 & thr == 0));
            false_positives(p, im) = sum(sum(fixatedArea(:,:,im) == 0 & thr == 1));
            true_negatives(p, im)  = sum(sum(fixatedArea(:,:,im) == 0 & thr == 0));
            salientPercent(p, im) = salientPercentAux(t);
            
            if 0
                figure;
                    imshow(thr)
                    hold on
                    [xaux, yaux] = find(fixatedArea(:,:,im) == 1 & thr == 1);
                    scatter(yaux,xaux,'go', 'filled')
                    [xaux, yaux] = find(fixatedArea(:,:,im) == 1 & thr == 0);
                    scatter(yaux,xaux,'ro', 'filled')
                    title([sprintf('top %.2f',salientPercentAux(t)) '% salient'])
            end
        end
    end
    
    meanSalientPercent = nan(length(salientPercentThr), 1);
    meanTPR = nan(length(salientPercentThr), 1);
    meanFPR = nan(length(salientPercentThr), 1);
    errTPR  = nan(length(salientPercentThr), 1);
    errFPR  = nan(length(salientPercentThr), 1);
    for p = 1:length(salientPercentThr)
        tmpTPR = nan(length(images), 1);
        tmpFPR = nan(length(images), 1);
        for im = 1:length(images)
%            if strcmp(location_words{im}, '-')
%                continue;
%            end
            tmpTPR(im) = true_positives(p, im) ./ (true_positives(p, im) + false_negatives(p, im));
            tmpFPR(im) = false_positives(p, im) ./ (false_positives(p, im) + true_negatives(p, im));
        end
        meanSalientPercent(p) = mean(salientPercent(p,:));
        errTPR(p)  = nanstd(tmpTPR) ./ sqrt(length(tmpTPR(~isnan(tmpTPR))));
        meanTPR(p) = nanmean(tmpTPR);
        errFPR(p)  = nanstd(tmpFPR) ./ sqrt(length(tmpFPR(~isnan(tmpFPR))));
        meanFPR(p) = nanmean(tmpFPR);
    end
    fprintf([num2str(toc), ' seconds \n']);
end

function [features, tRange] = fun_select_model(mode, images, im, cfg)
    switch mode
        % New models
        case {'mlnet', 'sam_resnet', 'sam_vgg', 'deepgaze', 'icf'}
            features = imread(['../saliency/' mode '/'          images{im}]);
            tRange = 0:1:255;

        % Old models
        case 'SAM'
            features = imread(['../saliency/sam/'               images{im}]);
            tRange = 0:1:255;
        case 'SAM+MLNet'
            tmp = imread(['../saliency/sam/'                    images{im}])
            features = imgaussfilt(max(tmp), tmp, 20);
            tRange = 0:1:255;
        case 'MLNetSmooth'
            features = imgaussfilt(imread(['../saliency/mlnet/' images{im}]), 20);
            tRange = 0:1:255;
        case 'MLNetSmooth+Center'
            features = imgaussfilt(imread(['../saliency/mlnet/' images{im}]), 20);
            center = reshape(findDistToCenterFeatures(zeros(768, 1024), [768 1024]), 768, 1024) <= 0.25;
            features = max(uint8(center * 255), features);
            tRange = 0:1:255;
        case 'CORS'
            features = imresize(imread(['../saliency/CORS/'     images{im}]), [768 1024]);
            tRange = 0:1:255;
        case 'LowLevel'
            template = imread(['../templates/' cfg.templates{im}]);
            img = imread(['../images/'                          images{im}]);
            features = low_level_correlation(template, img);
%                imwrite(uint8(round(features)), ['../saliency/lowlevel/' images{im}]);
            tRange = 0:1:255;
        case 'Judd'
            % I use horizonMode to tell which model to use
            features = juddSaliency(['../images/' images{im}], images{im}, ...
                                    ['../templates/' cfg.templates{im}], cfg.templates{im}, ...
                                    '../', cfg.horizonMode, cfg.modelIdx, cfg.ModelsJudd, cfg.ROCPerformancesJudd, cfg.dimsJudd);
            tRange = 0:0.01:1;
            imwrite(features, ['../saliency/judd_model_1_split/' images{im} '_geisler_judd_model_4_prior_3d+4.mat']);
        case 'Torralba'
            img = imread(['../images/' images{im}]);
            features = torralbaSaliency(img);
            features = imgaussfilt(features/(max(features(:))), 5);
            tRange = 0:0.05:1;

        % Null hypothesis / Simple models
        case 'CenteredHorizon'
            img = imread(['../images/' images{im}]);
            features = reshape(findHorizonFeatures(img, [768 1024], 'centered'), [768 1024]);
            tRange = 0:0.01:1;
        case 'Horizon'
            img = imread(['../images/' images{im}]);
            features = reshape(findHorizonFeatures(img, [768 1024], 'original'), [768 1024]);
            tRange = 0:0.01:1;
        case 'HorizonModified'
            img = imread(['../images/' images{im}]);
            table = table2cell(readtable('../matrices/target_location_0', 'Delimiter', ',', 'ReadVariableNames', false));
            [features, loc] = findHorizonModified(img, cfg.templates{im}, [768 1024], table, cfg.horizonMode, cfg.fixatedArea(:,:,im));
            features = reshape(features, [768 1024]);
            cfg.location_words = [cfg.location_words loc];
            tRange = 0:0.01:1;
        case 'CenterJudd' % Old Center
            features = 1 - reshape(findDistToCenterFeatures(zeros(768, 1024), [768 1024]), 768, 1024);
            tRange = 0:0.01:1;
        case 'Center'
            features = imread('../saliency/center.jpg');
            tRange = 0:1:255;
        case 'Target'
            features = imread(['../saliency/target_as_center/'      images{im}]);
            tRange = 0:1:255;
        case 'Noise'
            features = rand(768,1024);
            tRange = 0:0.01:1;

        % Humans
        case 'Humans3'
            features = imread(['../saliency/humans_fix_3_to_3/'     images{im}]);
            tRange = 0:1:255;
        case 'HumansGuessMapNotFound'
            features = imread(['../guesses_map_not_found/'          images{im}]);
            tRange = 0:1:255;
        case 'HumansGuessMapNotFoundTrain'
            features = imread(['../guesses_map_not_found_train/'    images{im}]);
            tRange = 0:1:255;
        case 'HumansGuessMap'
            features = imread(['../guesses_map/'                    images{im}]);
            tRange = 0:1:255;
        case 'HumansGuessMapTrain'
            features = imread(['../guesses_map_train_4/'            images{im}]);
            tRange = 0:1:255;
        otherwise
            fprintf('Invalid mode\n');
        return
    end
end
